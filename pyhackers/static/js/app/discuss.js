// Generated by CoffeeScript 1.6.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.Discuss = (function() {
    function Discuss(discussion_id) {
      this.discussion_id = discussion_id;
      this.discussDialog = __bind(this.discussDialog, this);
      this.reload = __bind(this.reload, this);
      this.init = __bind(this.init, this);
      this.lastMessage = null;
      this.template = window.Handlebars.compile($.trim($("#message-template").html()));
      console.log("Discussion started " + this.discussion_id);
    }

    Discuss.prototype.init = function() {
      if (this.discussion_id == null) {
        return;
      }
      window.setInterval(this.reload, 10000);
      return this.reload();
    };

    Discuss.prototype.reload = function() {
      var _this = this;
      return $.getJSON('/ajax/discuss/#{@discussion_id}/messages', {
        _: new Date().getTime(),
        after_id: this.lastMessage || -1
      }, function(data) {
        console.log(data);
        _this.lastMessage = data.discussion.last_message;
        return $(".posts").append(_this.template({
          message: data.posts
        }));
      });
    };

    Discuss.prototype.discussDialog = function() {
      var $template;
      $template = $($("#discuss-template").html());
      $(body).append($template);
      return $template.modal();
    };

    return Discuss;

  })();

  $(function() {
    var discuss;
    discuss = new Discuss($("#discussion_id").val());
    discuss.init();
    return $(document).on('click', '[href="#discuss-dialog"]', discuss.discussDialog);
  });

}).call(this);
