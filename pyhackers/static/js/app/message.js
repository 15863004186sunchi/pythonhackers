// Generated by CoffeeScript 1.6.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.Message = (function() {
    function Message() {
      this.editMessage = __bind(this.editMessage, this);
      this.deleteMessage = __bind(this.deleteMessage, this);
      this.showMessage = __bind(this.showMessage, this);
      this.editTemplate = window.Handlebars.compile($.trim($("#edit-message-template").html()));
      this.listen();
    }

    Message.prototype.listen = function() {
      var _this = this;
      $(document).on('click', '[data-trigger="message"]', function(evt) {
        return _this.showMessage(evt);
      });
      $(document).on('click', '[data-trigger="upvote"]', function(evt) {
        return _this.upvote(evt);
      });
      $(document).on('click', '[data-action="edit-message"]', function(evt) {
        return _this.editMessage(evt);
      });
      return $(document).on('click', '[data-action="delete-message"]', function(evt) {
        return _this.deleteMessage(evt);
      });
    };

    Message.prototype.upvote = function(evt) {
      var messageId;
      $(evt.target).css({
        color: 'orange'
      });
      messageId = $(evt.currentTarget).parents('[data-message-id]').attr("data-message-id");
      evt.stopPropagation();
      evt.preventDefault();
      return $.post("/ajax/message/" + messageId + "/upvote", {
        message: messageId
      }, function(data) {
        return console.log(data);
      });
    };

    Message.prototype.showMessage = function(evt) {
      return vex.dialog.open({
        message: "Whats up",
        input: "<textarea rows=\"3\" name=\"message\" required ></textarea>",
        buttons: [
          $.extend({}, vex.dialog.buttons.YES, {
            text: 'Post'
          }), $.extend({}, vex.dialog.buttons.NO, {
            text: 'Back',
            "class": 'pull-left'
          })
        ],
        callback: function(data) {
          if (data === false) {
            return console.log('Cancelled');
          }
          console.log('Username', data.message);
          return $.post('/ajax/message/new', {
            message: data.message
          }, function() {
            console.log("Ok");
            return Messenger().post({
              message: "Message has been sent",
              type: "success"
            });
          });
        }
      });
    };

    Message.prototype.deleteMessage = function(evt) {
      var $target, href;
      $target = $(evt.target);
      href = $target.attr("href");
      $.post(href, {}, function(response) {
        if (response.ok) {
          return $target.parents("[data-message-id]").remove();
        }
      });
      evt.stopPropagation();
      return evt.preventDefault();
    };

    Message.prototype.editMessage = function(evt) {
      var $messageContainer, $messagePanel, messageId,
        _this = this;
      $messagePanel = $(evt.target).parents('[data-message-id]');
      messageId = $messagePanel.attr('data-message-id');
      $messageContainer = $messagePanel.find(".panel-body .message");
      $messageContainer.html(this.editTemplate({
        id: messageId
      }));
      $.getJSON("/ajax/post/" + messageId, function(response) {
        return $messageContainer.find("textarea").val(response.data.text).autosize();
      });
      $messageContainer.find("form").on("ajax:success", function(evt, response) {
        if (response.ok) {
          return $messageContainer.html(response.data.html);
        } else {
          return alert("Failed to update.");
        }
      });
      evt.stopPropagation();
      return evt.preventDefault();
    };

    return Message;

  })();

  jQuery(function() {
    var msg;
    return msg = new Message();
  });

}).call(this);
